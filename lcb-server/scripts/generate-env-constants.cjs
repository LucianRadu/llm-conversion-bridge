#!/usr/bin/env node

/*
 * ADOBE CONFIDENTIAL
 * ___________________
 * Copyright 2025 Adobe
 * All Rights Reserved.
 * NOTICE: All information contained herein is, and remains
 * the property of Adobe and its suppliers, if any. The intellectual
 * and technical concepts contained herein are proprietary to Adobe
 * and its suppliers and are protected by all applicable intellectual
 * property laws, including trade secret and copyright laws.
 *  Dissemination of this information or reproduction of this material
 * is strictly forbidden unless prior written permission is obtained
 * from Adobe.
 */

/**
 * Generate env-constants.ts from process.env at build time
 * This allows us to inject environment variables into the WASM bundle
 */

const fs = require('fs');
const path = require('path');

// Check if AEM_COMPUTE_SERVICE is set
const aemComputeService = process.env.AEM_COMPUTE_SERVICE;

if (!aemComputeService) {
  console.error('ERROR: AEM_COMPUTE_SERVICE environment variable is required');
  console.error('Add it to your .env file with format: p<project>-e<env>-<service-name>');
  process.exit(1);
}

// Validate format
if (!/^p[0-9]+-e[0-9]+-[a-zA-Z0-9_-]+$/.test(aemComputeService)) {
  console.error(`ERROR: Invalid AEM_COMPUTE_SERVICE format: "${aemComputeService}"`);
  console.error('Expected format: p<project>-e<env>-<service-name>');
  process.exit(1);
}

// Generate TypeScript file
const content = `/*
 * ADOBE CONFIDENTIAL
 * ___________________
 * Copyright 2025 Adobe
 * All Rights Reserved.
 * NOTICE: All information contained herein is, and remains
 * the property of Adobe and its suppliers, if any. The intellectual
 * and technical concepts contained herein are proprietary to Adobe
 * and its suppliers and are protected by all applicable intellectual
 * property laws, including trade secret and copyright laws.
 *  Dissemination of this information or reproduction of this material
 * is strictly forbidden unless prior written permission is obtained
 * from Adobe.
 */

/**
 * Environment constants injected at build time from .env file
 * DO NOT EDIT THIS FILE - it is auto-generated by scripts/generate-env-constants.js
 */

export const BUILD_TIME_ENV = {
  AEM_COMPUTE_SERVICE: "${aemComputeService}"
} as const;
`;

const outputPath = path.join(__dirname, '../server/src/constants/env-constants.ts');
fs.writeFileSync(outputPath, content, 'utf-8');

console.log(`âœ“ Generated env-constants.ts with AEM_COMPUTE_SERVICE="${aemComputeService}"`);

